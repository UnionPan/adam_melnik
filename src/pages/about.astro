---
import BaseHead from '../components/BaseHead.astro';
import { SITE_TITLE } from '../consts';
import { readFile, readdir } from 'fs/promises';
import { resolve } from 'path';

const photoFolders = await readdir('public/photos', { withFileTypes: true })
	.then(entries => entries
		.filter(entry => entry.isDirectory())
		.map(entry => entry.name)
		.sort((a, b) => {
			// Put Street first, then alphabetical order for others
			if (a === 'Street') return -1;
			if (b === 'Street') return 1;
			return a.localeCompare(b);
		})
	);

// Read the markdown file
const aboutContent = await readFile(resolve(process.cwd(), 'src/content/about.md'), 'utf-8');

// Simple markdown to HTML conversion for basic formatting
function markdownToHtml(md: string): string {
  return md
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Handle font changes
    .replace(/\{font:([^}]+)\}(.+?)\{\/font\}/g, '<span style="font-family: $1;">$2</span>')
    .replace(/\{mono\}(.+?)\{\/mono\}/g, '<span style="font-family: \'droid-sans-mono\', \'Roboto Mono\', monospace;">$1</span>')
    .replace(/\{serif\}(.+?)\{\/serif\}/g, '<span style="font-family: \'Times New Roman\', Times, serif;">$1</span>')
    .replace(/\{sans\}(.+?)\{\/sans\}/g, '<span style="font-family: Arial, Helvetica, sans-serif;">$1</span>')
    // Handle images first (before links)
    .replace(/!\[(.+?)\]\(dist\/(.+?)\)/g, '<img src="/$2" alt="$1" style="max-width: 500px; border-radius: 8px; margin: 1rem auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: block;" />')
    .replace(/!\[(.+?)\]\((.+?)\)/g, '<img src="$2" alt="$1" style="max-width: 500px; border-radius: 8px; margin: 1rem auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: block;" />')
    // Handle image links that should display as images 
    .replace(/\[([^\]]*)\]\((dist\/[^)]+)\)/g, '<img src="/$2" alt="$1" style="max-width: 500px; border-radius: 8px; margin: 1rem auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: block;" />')
    .replace(/\[([^\]]*)\]\(([^)]+\.(jpg|png|gif|webp))\)/g, '<img src="$2" alt="$1" style="max-width: 500px; border-radius: 8px; margin: 1rem auto; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); display: block;" />')
    // Handle regular links
    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/^(?!<[h|u|l|i])/gm, '<p>')
    .replace(/(?<![h|l|g]>)$/gm, '</p>')
    .replace(/<p><\/p>/g, '')
    .replace(/<p>---<\/p>/g, '<hr>');
}

const htmlContent = markdownToHtml(aboutContent);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title="About Adam Melnik" description="Learn more about Adam Melnik's journey as a lighting designer and passionate photographer" />
	</head>
	<body>
		<div class="homepage-container">
			<button class="theme-toggle" aria-label="Toggle theme">
				<svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
					<line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>
				<svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
			</button>
			<button class="mobile-menu-toggle" aria-label="Toggle menu">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					<path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					<path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					<path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
					<path d="M10 9H9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
			</button>
			<aside class="sidebar">
				<div class="sidebar-content">
					<h1><a href="/" class="site-title">Adam Melnik</a></h1>
					
					<nav class="main-nav">
						<ul>
							{photoFolders.map((folder) => (
								<li><a href={`/?category=${folder}`}>{folder === 'rock' ? 'Rock' : folder.replace(/_/g, ' ')}</a></li>
							))}
						</ul>
						
						<ul>
							<li><a href="/about" class="active">About Me</a></li>
							<li><a href="/contact">Contact</a></li>
						</ul>
					</nav>
					
				</div>
				
				<footer class="sidebar-footer">
					<a href="https://www.instagram.com/adammelnik/" target="_blank" class="social-link">
						<svg viewBox="0 0 16 16" aria-hidden="true" width="20" height="20">
							<path fill="currentColor" d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.374.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"></path>
						</svg>
						Instagram
					</a>
					all contents Â© 2025. all rights reserved.
				</footer>
			</aside>
			
			<main class="content-column">
				<div class="content-scroll">
					<div class="content-section" set:html={htmlContent}>
					</div>
				</div>
			</main>
		</div>

		<script is:inline>
			// Theme toggle - must run before page renders to avoid flash
			(function() {
				const theme = localStorage.getItem('theme') ||
					(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
				document.documentElement.setAttribute('data-theme', theme);
			})();
		</script>

		<script>
			// Theme toggle handler
			const themeToggle = document.querySelector('.theme-toggle');
			themeToggle?.addEventListener('click', () => {
				const currentTheme = document.documentElement.getAttribute('data-theme');
				const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
				document.documentElement.setAttribute('data-theme', newTheme);
				localStorage.setItem('theme', newTheme);
			});

			// Mobile menu toggle
			const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
			const sidebar = document.querySelector('.sidebar');

			mobileMenuToggle?.addEventListener('click', () => {
				sidebar?.classList.toggle('active');
				mobileMenuToggle.classList.toggle('active');
			});

			// Close sidebar when clicking a link on mobile (but not dropdown toggles)
			const sidebarLinks = document.querySelectorAll('.sidebar a');
			sidebarLinks.forEach(link => {
				link.addEventListener('click', () => {
					// Don't close sidebar if clicking a dropdown toggle
					if (link.classList.contains('dropdown-toggle')) {
						return;
					}
					if (window.innerWidth <= 768) {
						sidebar?.classList.remove('active');
						mobileMenuToggle?.classList.remove('active');
					}
				});
			});
		</script>
	</body>
</html>
