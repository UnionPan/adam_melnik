---
import BaseHead from '../components/BaseHead.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { readdir } from 'fs/promises';
import path from 'path';

const photoFolders = await readdir('public/photos', { withFileTypes: true })
	.then(entries => entries
		.filter(entry => entry.isDirectory())
		.map(entry => entry.name)
		.sort((a, b) => {
			// Put Street first, then alphabetical order for others
			if (a === 'Street') return -1;
			if (b === 'Street') return 1;
			return a.localeCompare(b);
		})
	);

// Fisher-Yates shuffle algorithm
function shuffleArray(array) {
	const shuffled = [...array];
	for (let i = shuffled.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
	}
	return shuffled;
}

// Load landing page photos
let landingPhotos = [];
try {
	const landingEntries = await readdir('public/landing', { withFileTypes: true });
	landingPhotos = landingEntries
		.filter(entry => entry.isFile() && /\.(jpg|jpeg|png|gif|webp)$/i.test(entry.name))
		.map(entry => ({
			src: `/landing/${entry.name}`,
			alt: 'Adam Melnik Photography'
		}));
	landingPhotos = shuffleArray(landingPhotos);
} catch (error) {
	console.error('Error loading landing photos:', error);
}

// Load all photos for each folder
const photoCollections = {};
for (const folder of photoFolders) {
	try {
		const entries = await readdir(path.join('public/photos', folder), { withFileTypes: true });
		const photoObjects = entries
			.filter(entry => entry.isFile() && /\.(jpg|jpeg|png|gif|webp)$/i.test(entry.name))
			.map(entry => ({
				src: `/photos/${folder}/${entry.name}`,
				alt: `${folder === 'rock' ? 'Rock' : folder.replace(/_/g, ' ')} Photo`
			}));
		photoCollections[folder] = shuffleArray(photoObjects);

		// Add subcategories for Street
		if (folder === 'Street') {
			try {
				// Check if NYC subfolder exists
				const nycPhotos = await readdir(path.join('public/photos', folder, 'NYC'));
				const nycPhotoObjects = nycPhotos
					.filter(file => /\.(jpg|jpeg|png|gif|webp)$/i.test(file))
					.map(file => ({
						src: `/photos/${folder}/NYC/${file}`,
						alt: 'NYC Street Photo'
					}));
				photoCollections['Street/NYC'] = shuffleArray(nycPhotoObjects);
			} catch (error) {
				photoCollections['Street/NYC'] = [];
			}

			try {
				// Check if Rajasthan subfolder exists
				const rajasthanPhotos = await readdir(path.join('public/photos', folder, 'Rajasthan'));
				const rajasthanPhotoObjects = rajasthanPhotos
					.filter(file => /\.(jpg|jpeg|png|gif|webp)$/i.test(file))
					.map(file => ({
						src: `/photos/${folder}/Rajasthan/${file}`,
						alt: 'Rajasthan Street Photo'
					}));
				photoCollections['Street/Rajasthan'] = shuffleArray(rajasthanPhotoObjects);
			} catch (error) {
				photoCollections['Street/Rajasthan'] = [];
			}
		}

		// Add subcategories for Events
		if (folder === 'Events') {
			try {
				// Check if Lisa's 60th subfolder exists
				const lisaPhotos = await readdir(path.join('public/photos', folder, "Lisa's 60th"));
				const lisaPhotoObjects = lisaPhotos
					.filter(file => /\.(jpg|jpeg|png|gif|webp)$/i.test(file))
					.map(file => ({
						src: `/photos/${folder}/Lisa's 60th/${file}`,
						alt: "Lisa's 60th Birthday Photo"
					}));
				photoCollections["Events/Lisa's 60th"] = shuffleArray(lisaPhotoObjects);
			} catch (error) {
				photoCollections["Events/Lisa's 60th"] = [];
			}

			try {
				// Check if Julia + Spencer subfolder exists
				const juliaSpencerPhotos = await readdir(path.join('public/photos', folder, 'Julia + Spencer'));
				const juliaSpencerPhotoObjects = juliaSpencerPhotos
					.filter(file => /\.(jpg|jpeg|png|gif|webp)$/i.test(file))
					.map(file => ({
						src: `/photos/${folder}/Julia + Spencer/${file}`,
						alt: 'Julia + Spencer Event Photo'
					}));
				photoCollections['Events/Julia + Spencer'] = shuffleArray(juliaSpencerPhotoObjects);
			} catch (error) {
				photoCollections['Events/Julia + Spencer'] = [];
			}
		}
	} catch (error) {
		photoCollections[folder] = [];
	}
}
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body>
		<div class="homepage-container">
			<button class="theme-toggle" aria-label="Toggle theme">
				<svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
					<line x1="12" y1="1" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="12" y1="21" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="4.22" y1="4.22" x2="5.64" y2="5.64" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="18.36" y1="18.36" x2="19.78" y2="19.78" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="1" y1="12" x2="3" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="21" y1="12" x2="23" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="4.22" y1="19.78" x2="5.64" y2="18.36" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
					<line x1="18.36" y1="5.64" x2="19.78" y2="4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
				</svg>
				<svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
				</svg>
			</button>
			<button class="mobile-menu-toggle" aria-label="Toggle menu">
				<svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
					<circle cx="12" cy="12" r="9.5" stroke="currentColor" stroke-width="1.2"/>
					<circle cx="12" cy="12" r="6.5" stroke="currentColor" stroke-width="0.8" opacity="0.35"/>
					<line x1="12" y1="1.75" x2="12" y2="3.75" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
					<line x1="12" y1="20.25" x2="12" y2="22.25" stroke="currentColor" stroke-width="1" stroke-linecap="round" opacity="0.6"/>
					<line x1="1.75" y1="12" x2="3.75" y2="12" stroke="currentColor" stroke-width="1" stroke-linecap="round" opacity="0.6"/>
					<line x1="20.25" y1="12" x2="22.25" y2="12" stroke="currentColor" stroke-width="1" stroke-linecap="round" opacity="0.6"/>
					<g class="compass-needle">
						<path d="M12 4.2 L15 12 L12 19.8 L9 12 Z" fill="currentColor"/>
						<path d="M12 4.2 L13.4 8.8 L12 10.2 L10.6 8.8 Z" fill="currentColor" opacity="0.6"/>
					</g>
					<circle cx="12" cy="12" r="1.4" fill="var(--bg-primary)"/>
					<circle cx="12" cy="12" r="0.6" fill="currentColor"/>
				</svg>
			</button>
			<aside class="sidebar">
				<div class="sidebar-content">
					<h1><a href="/" class="site-title">Adam Melnik</a></h1>
					
					<nav class="main-nav">
						<ul>
							{photoFolders.map((folder, index) => {
								const displayName = folder === 'rock' ? 'Rock' : folder.replace(/_/g, ' ');
								if (folder === 'Street') {
									return (
										<li class="dropdown-item">
											<a href="#" data-category={folder} class="category-link dropdown-toggle">{displayName}</a>
											<ul class="dropdown-menu">
												<li><a href="#" data-category="Street/NYC" class="category-link dropdown-link">New York City</a></li>
												<li><a href="#" data-category="Street/Rajasthan" class="category-link dropdown-link">Rajasthan, India</a></li>
											</ul>
										</li>
									);
								} else if (folder === 'Events') {
									return (
										<li class="dropdown-item">
											<a href="#" data-category={folder} class="category-link dropdown-toggle">{displayName}</a>
											<ul class="dropdown-menu">
												<li><a href="#" data-category="Events/Lisa's 60th" class="category-link dropdown-link">Lisa's 60th</a></li>
												<li><a href="#" data-category="Events/Julia + Spencer" class="category-link dropdown-link">Julia + Spencer</a></li>
											</ul>
										</li>
									);
								} else {
									return (
										<li><a href="#" data-category={folder} class={`category-link ${index === 0 ? 'active' : ''}`}>{displayName}</a></li>
									);
								}
							})}
						</ul>
						
						<ul>
							<li><a href="/about">About Me</a></li>
							<li><a href="/contact">Contact</a></li>
						</ul>
					</nav>
					
				</div>
				
				<footer class="sidebar-footer">
					<a href="https://www.instagram.com/adammelnik/" target="_blank" class="social-link">
						<svg viewBox="0 0 16 16" aria-hidden="true" width="20" height="20">
							<path fill="currentColor" d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.374.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"></path>
						</svg>
						Instagram
					</a>
					all contents Â© 2025. all rights reserved.
				</footer>
			</aside>
			
			<main class="photo-column">
				<div class="photo-scroll">
					<div class="landing-image" id="landingImage">
						<div class="masonry-grid">
							<!-- Landing images will be dynamically loaded here -->
						</div>
					</div>
					<div class="photo-container" id="photoContainer">
						<!-- Photos will be dynamically loaded here -->
					</div>
				</div>
			</main>
		</div>

		<script is:inline>
			// Theme toggle - must run before page renders to avoid flash
			(function() {
				const theme = localStorage.getItem('theme') ||
					(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
				document.documentElement.setAttribute('data-theme', theme);
			})();
		</script>

		<script>
			// Theme toggle handler
			const themeToggle = document.querySelector('.theme-toggle');
			themeToggle?.addEventListener('click', () => {
				const currentTheme = document.documentElement.getAttribute('data-theme');
				const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
				document.documentElement.setAttribute('data-theme', newTheme);
				localStorage.setItem('theme', newTheme);
			});

			// Mobile menu toggle
			const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
			const sidebar = document.querySelector('.sidebar');

			mobileMenuToggle?.addEventListener('click', () => {
				sidebar?.classList.toggle('active');
				mobileMenuToggle.classList.toggle('active');
			});

			// Close sidebar when clicking a link on mobile (but not dropdown toggles)
			const sidebarLinks = document.querySelectorAll('.sidebar a');
			sidebarLinks.forEach(link => {
				link.addEventListener('click', () => {
					// Don't close sidebar if clicking a dropdown toggle
					if (link.classList.contains('dropdown-toggle')) {
						return;
					}
					if (window.innerWidth <= 768) {
						sidebar?.classList.remove('active');
						mobileMenuToggle?.classList.remove('active');
					}
				});
			});
		</script>

		<script define:vars={{ photoCollections, landingPhotos }}>
			document.addEventListener('DOMContentLoaded', function() {
				const categoryLinks = document.querySelectorAll('.category-link');
				const photoContainer = document.getElementById('photoContainer');
				const landingImage = document.getElementById('landingImage');
				const dropdownItems = document.querySelectorAll('.dropdown-item');

				function createMasonryItem(photo) {
					const item = document.createElement('div');
					item.className = 'masonry-item';

					// Randomly assign size classes for variation
					const sizeClass = Math.random() > 0.7 ? 'large' : Math.random() > 0.5 ? 'medium' : 'small';
					item.classList.add(sizeClass);

					const img = document.createElement('img');
					img.src = photo.src;
					img.alt = photo.alt;
					img.loading = 'lazy';

					item.appendChild(img);
					return item;
				}

				function createPhotoElement(photo, delay = 0) {
					const photoItem = document.createElement('div');
					photoItem.className = 'photo-item';
					photoItem.style.animationDelay = `${delay}s`;
					photoItem.style.opacity = '0';
					photoItem.style.transform = 'translateY(20px)';

					const img = document.createElement('img');
					img.src = photo.src;
					img.alt = photo.alt;

					photoItem.appendChild(img);

					// Trigger fade-in animation
					setTimeout(() => {
						photoItem.style.opacity = '1';
						photoItem.style.transform = 'translateY(0)';
					}, delay * 100);

					return photoItem;
				}

				let currentPhotoIndex = 0;
				let currentCategory = null;

				function loadPhotos(categoryName) {
					console.log('Loading photos for category:', categoryName);
					console.log('Available collections:', Object.keys(photoCollections));
					console.log('Photos for category:', photoCollections[categoryName]);

					// Hide landing image and show photo container
					landingImage.style.display = 'none';
					photoContainer.style.display = 'flex';
					photoContainer.innerHTML = '';

					const photos = photoCollections[categoryName];
					if (!photos || photos.length === 0) {
						console.log('No photos found for category:', categoryName);
						return;
					}

					currentCategory = categoryName;
					currentPhotoIndex = 0;

					// Create single photo viewer
					const photoViewer = document.createElement('div');
					photoViewer.className = 'photo-viewer';

					const photoWrapper = document.createElement('div');
					photoWrapper.className = 'photo-wrapper';

					const img = document.createElement('img');
					img.src = photos[currentPhotoIndex].src;
					img.alt = photos[currentPhotoIndex].alt;
					img.className = 'viewer-image';

					// Create navigation overlays
					const leftNav = document.createElement('div');
					leftNav.className = 'nav-overlay nav-left';
					leftNav.addEventListener('click', () => navigatePhoto(-1));

					const rightNav = document.createElement('div');
					rightNav.className = 'nav-overlay nav-right';
					rightNav.addEventListener('click', () => navigatePhoto(1));

					photoWrapper.appendChild(img);
					photoWrapper.appendChild(leftNav);
					photoWrapper.appendChild(rightNav);
					photoViewer.appendChild(photoWrapper);

					photoContainer.appendChild(photoViewer);
				}

				function navigatePhoto(direction) {
					if (!currentCategory) return;

					const photos = photoCollections[currentCategory];
					if (!photos || photos.length === 0) return;

					// Update index with wrapping
					currentPhotoIndex = (currentPhotoIndex + direction + photos.length) % photos.length;

					// Update image
					const img = photoContainer.querySelector('.viewer-image');

					if (img) {
						img.src = photos[currentPhotoIndex].src;
						img.alt = photos[currentPhotoIndex].alt;
					}
				}

				function showLandingImage() {
					// Show landing image and hide photo container
					landingImage.style.display = 'block';
					photoContainer.style.display = 'none';

					// Populate landing page with masonry grid using landing folder photos
					const masonryGrid = landingImage.querySelector('.masonry-grid');
					masonryGrid.innerHTML = '';

					landingPhotos.forEach((photo) => {
						const item = createMasonryItem(photo);
						masonryGrid.appendChild(item);
					});
				}

				function selectCategory(selectedCategory) {
					// Remove active class from all links
					categoryLinks.forEach(l => l.classList.remove('active'));

					// Remove active class from dropdown items
					dropdownItems.forEach(item => item.classList.remove('active'));

					// Add active class to clicked link
					const targetLink = document.querySelector(`[data-category="${selectedCategory}"]`);
					if (targetLink) {
						targetLink.classList.add('active');

						// If this is a dropdown link, also activate the parent dropdown
						const parentDropdown = targetLink.closest('.dropdown-item');
						if (parentDropdown) {
							parentDropdown.classList.add('active');
						}
					}

					// Load photos for the selected category
					loadPhotos(selectedCategory);
				}

				// Initialize with landing image
				showLandingImage();

				// Add click listener to site title to return to landing page
				const siteTitle = document.querySelector('.site-title');
				if (siteTitle) {
					siteTitle.addEventListener('click', function(e) {
						e.preventDefault();
						// Remove active class from all links
						categoryLinks.forEach(l => l.classList.remove('active'));
						dropdownItems.forEach(item => item.classList.remove('active'));
						showLandingImage();
					});
				}

				// Add click listeners to category links
				categoryLinks.forEach(link => {
					link.addEventListener('click', function(e) {
						e.preventDefault();
						e.stopPropagation();

						// If this is a dropdown toggle, handle dropdown behavior
						if (this.classList.contains('dropdown-toggle')) {
							const parentItem = this.closest('.dropdown-item');

							if (!parentItem) {
								return;
							}

							const isCurrentlyActive = parentItem.classList.contains('active');

							// Close all other dropdowns
							dropdownItems.forEach(di => {
								if (di !== parentItem) {
									di.classList.remove('active');
								}
							});

							// Toggle this dropdown
							if (isCurrentlyActive) {
								parentItem.classList.remove('active');
							} else {
								parentItem.classList.add('active');
							}
							return;
						}

						// Otherwise load photos for this category
						const selectedCategory = this.dataset.category;
						selectCategory(selectedCategory);
					});
				});
			});
		</script>
	</body>
</html>
